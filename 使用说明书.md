# BCI-Flystick 使用说明书

## 1. 项目简介
BCI-Flystick 是一个开源脑机接口控制框架，利用 OpenBCI Cyton 采集实时脑电（EEG）信号，经过 Python 端的特征提取与滤波处理后，将姿态与油门指令通过 UDP 发送给下游的虚拟摇杆服务（Windows 上的 vJoy 或 Linux 上的 uinput），进而控制飞行模拟器或机器人平台。项目同时提供离线仿真模式，方便在没有硬件的情况下完成开发与调试。

## 2. 目标读者
本说明书适用于：
- 想要快速部署脑控飞行实验的研究人员与学生。
- 希望在飞行模拟器、无人机平台或游戏中尝试脑机接口控制的开发者。
- 需要了解工程架构以便二次开发的程序员。

## 3. 系统组成
```
EEG（C3, C4, Cz, Oz）
      ↓
 OpenBCI Cyton 数据采集
      ↓
 BrainFlow Python SDK
      ↓
 特征提取（μ/β 运动想象、α/SSVEP 视觉注意）
      ↓
 UDP 四轴指令流（Yaw / Altitude / Pitch / Throttle）
      ↓
 虚拟摇杆（vJoy / uinput）
      ↓
 飞行模拟器或机器人平台
```

## 4. 硬件与软件需求
### 4.1 硬件
- OpenBCI Cyton（可选 Daisy 拓展板以获得 16 通道）。
- 脑电帽或电极，至少覆盖 C3、C4、Cz、Oz 四个位置。
- 运行 BCI-Flystick 的计算机（Windows 10+/Linux）。
- 可选：飞行控制器、无人机或游戏控制平台。

### 4.2 软件
- Python 3.9 及以上。
- Rust 1.72 及以上（仅在需编译 rust/bci_receiver 时使用）。
- Git、Make（可选）。
- Windows 端需要安装 vJoy；Linux 端需具备 uinput 权限。

## 5. 环境部署步骤
0. **一键环境准备（可选）**
   ```bash
   bash <(curl -fsSL https://raw.githubusercontent.com/Skiyoshika/BCI-Flystick/main/scripts/bootstrap.sh)
   ```
   该脚本会自动完成仓库克隆/更新、创建 `.venv` 虚拟环境并安装 Python 依赖。若已经下载好仓库，可在仓库根目录执行：

   ```bash
   bash scripts/bootstrap.sh --skip-git
   ```

1. **克隆仓库**
   ```bash
   git clone https://github.com/Skiyoshika/BCI-Flystick.git
   cd BCI-Flystick
   ```
2. **创建 Python 虚拟环境**
   ```bash
   python -m venv .venv
   # Windows PowerShell
   & .\\.venv\\Scripts\\Activate.ps1
   # Windows CMD
   \\.venv\\Scripts\\activate.bat
   # Linux / macOS
   source .venv/bin/activate
   ```

   > ℹ️ **提示**：若在 PowerShell 中执行激活命令时仅打开了 `Activate.ps1` 文件，请确保命令以 `&` 或 `./` 开头，例如 `& .\\.venv\\Scripts\\Activate.ps1`。
3. **安装依赖**
   ```bash
   pip install -r python/requirements.txt
   ```
4. **运行中英双语引导程序（推荐）**
   ```bash
   python -m python.main --wizard              # 默认为英文
   python -m python.main --wizard --wizard-language zh  # 指定中文流程
   ```
   引导程序会：
   - 检查 numpy、scipy、pyyaml 等核心依赖是否可用。
   - 根据所选控制后端（Windows vJoy/ViGEm 或 Linux uinput）提示缺失的驱动/库。
   - 可选检查 BrainFlow SDK，以便在真实硬件模式下采集 OpenBCI 数据。
   - 引导填写 UDP 地址/端口、俯仰轴反向、油门缩放、是否开启模拟 EEG、是否自动启动终端仪表板等偏好。
   - 将配置保存在 `config/user_profiles/<名称>.json`，并自动记住最后一次选择。

5. **可选：Rust 组件**
   ```bash
   rustup toolchain install stable
   cd rust/bci_receiver
   cargo build --release
   ```

## 6. 配置文件说明
所有配置位于 `config/` 目录。

### 6.1 `channel_map.json`
```json
{
  "serial_port": "COM3",
  "board_id": "CYTON",
  "channels": { "C3": 0, "C4": 1, "Cz": 2, "Oz": 7 }
}
```
- `serial_port`：串口号（Windows 为 COM 口，Linux 为 `/dev/ttyUSB*`）。
- `board_id`：板卡类型，支持 `CYTON`、`CYTON_DAISY`、`GANGLION`、`SYNTHETIC`。
- `channels`：各电极对应的通道索引，需与实际接线一致。

### 6.2 `settings.yaml`
| 字段 | 类型 | 含义 |
|------|------|------|
| `sample_rate` | float | 用于一致性检查的目标采样率 |
| `bandpass` | [float, float] | 带通滤波上下截止频率（Hz） |
| `notch` | float | 工频陷波（50/60 Hz） |
| `window_sec` / `hop_sec` | float | STFT 窗口长度与滑步（秒） |
| `ewma_alpha` | float | 指令平滑的指数衰减系数 |
| `dead_band` | float | 输出死区，过滤微弱波动 |
| `gains` | dict | Yaw、Altitude、Pitch、Throttle 四轴增益 |
| `calibration_sec` | float | 基线校准时长（秒） |
| `udp_target` | [str, int] | UDP 目标地址与端口 |

### 6.3 用户配置档 `user_profiles/*.json`
运行引导程序后，会在 `config/user_profiles/` 目录下生成个性化配置档案，最后一次使用的配置路径会写入 `.last_profile`，供统一入口自动加载。字段说明：

| 字段 | 类型 | 说明 |
|------|------|------|
| `language` | str | 引导时选择的界面语言（`en` 或 `zh`），用于运行时提示 |
| `control_backend` | str | `vigem`（Windows vJoy/ViGEm）或 `uinput`（Linux 虚拟摇杆） |
| `udp_host` / `udp_port` | str / int | 控制器、虚拟摇杆与仪表板共用的 UDP 地址与端口 |
| `invert_pitch` | bool | 是否在运行时反转俯仰轴 |
| `throttle_scale` | float | 油门缩放倍率（0.1–2.0），用于适配不同模拟器的灵敏度 |
| `mock_mode` | bool | 是否默认启用模拟 EEG（无需连接 OpenBCI 硬件） |
| `launch_dashboard` | bool | 启动时是否自动打开终端遥测仪表板 |

## 7. 启动流程
### 7.1 推荐：统一运行入口
```bash
# 直接加载最近一次使用的配置
python -m python.main

# 指定配置档（可使用绝对路径/自定义名称）
python -m python.main --config config/user_profiles/my_profile.json

# 常用覆盖参数
python -m python.main --mock           # 强制使用模拟 EEG（忽略配置档设定）
python -m python.main --hardware       # 强制连接真实 OpenBCI
python -m python.main --no-dashboard   # 不自动启动终端仪表板
```
统一入口会读取配置档，自动启动以下进程，并在按下 `Ctrl+C` 后依次发送 SIGINT 实现平滑退出：
- **BCI 控制器**（`python.bci_controller`）：完成 BrainFlow 数据接入、特征提取与四轴指令输出，运行时会套用配置档中的俯仰反转与油门缩放。
- **虚拟摇杆桥接**（`python.feed_vjoy` / `python.feed_uinput`）：根据操作系统自动选择，使用同一组 UDP 地址/端口。
- **终端遥测仪表板**（`python.udp_dashboard`）：若配置为启用，将实时显示 Yaw/Altitude/Pitch/Throttle 曲线，便于校准与监控。

### 7.2 手动启动（高级调试）
在需要逐个排查模块或进行自定义组合时，可独立运行以下命令：
```bash
# 控制器（真实硬件 / 模拟）
python python/bci_controller.py --udp-host 127.0.0.1 --udp-port 5005
python python/bci_controller.py --mock --duration 30

# Windows vJoy / ViGEm 桥接
python python/feed_vjoy.py --host 127.0.0.1 --port 5005 --device-id 1

# Linux uinput 桥接
sudo python python/feed_uinput.py --host 127.0.0.1 --port 5005

# 终端遥测仪表盘
python python/udp_dashboard.py --host 127.0.0.1 --port 5005
```
请确保所有进程使用一致的 UDP 地址与端口，并在调试结束后手动关闭各个终端窗口。

## 8. 常见操作场景
1. **飞行模拟器（如 PX4 SITL + QGroundControl）**
   - 在软件中绑定轴：X→Yaw，Y→Altitude，Z→Throttle，旋钮→Pitch。
   - 调整死区 5%~10%，以减少漂移。
2. **无人机真实飞行**
   - 建议在仿真环境充分验证后再接入真实无人机。
   - 为安全起见，可设置物理紧急停机开关。
3. **科研实验记录**
   - 通过修改 `python/loggers.py` 自定义实验标签与数据落盘格式。

## 9. 故障排查
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法连接板卡 | 串口号错误；权限不足 | 检查 `serial_port`；Linux 下运行 `sudo usermod -a -G dialout $USER` 后重登 |
| 输出轴漂移 | 电极接触不良；未完成校准 | 重新检查电极阻抗；确保基线阶段保持静止放松 |
| vJoy 无法识别 | 驱动未安装或版本过旧 | 重新安装 vJoy，并在设备管理器确认设备正常 |
| uinput 拒绝访问 | 未授予权限 | 确认 `/etc/udev/rules.d` 中的 uinput 规则，或使用 `sudo` 启动 |
| Python 程序退出 | 配置缺失或 JSON/YAML 格式错误；未生成配置档 | 使用 `python -m json.tool config/channel_map.json`、`yamllint config/settings.yaml` 校验；若提示 “No profile specified”，请先运行 `python -m python.main --wizard` |

## 10. 自检与测试
仓库提供以下命令帮助确认环境配置正确：
```bash
python -m compileall python        # Python 语法检查
pytest                             # Python 单元测试
cargo test --manifest-path rust/bci_receiver/Cargo.toml  # Rust 测试
```
如需持续集成，可参考 `.github/workflows`（若存在）或自行编写流水线脚本。

## 11. 二次开发建议
- **模块化结构**：Python 端的信号处理逻辑位于 `python/` 目录，可按模块拆分与扩展。
- **配置驱动**：优先通过修改 `config/` 内文件调参，避免在代码中硬编码。
- **日志记录**：可在控制器中加入实验标签、性能指标，便于追踪研究结果。
- **多模态扩展**：如需融合眼动或 EMG，可在 UDP 协议中添加新轴或自定义消息格式。

## 12. 许可证与引用
本项目遵循仓库根目录中的 `LICENSE`。如在论文或项目中使用，请引用 GitHub 仓库并说明所用版本。

---
若在部署过程中遇到问题，可在 GitHub Issues 中提交反馈或贡献修复 PR。
